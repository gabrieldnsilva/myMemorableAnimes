<!DOCTYPE html>
<html lang="pt-BR">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>
			<%= typeof title !== 'undefined' ? title : 'CatÃ¡logo de Animes' %>
		</title>

		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap"
			rel="stylesheet"
		/>

		<link rel="stylesheet" href="/css/output.css" />

		<script
			defer
			src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
		></script>

		<script src="https://unpkg.com/htmx.org@1.9.10"></script>
	</head>
	<body class="bg-black text-white min-h-screen flex flex-col font-sans">
		<%- include('../partials/header') %> <%-
		include('../partials/flashMessages') %>

		<main id="main-content" class="flex-grow">
			<section
				class="relative min-h-screen overflow-hidden flex items-center justify-center py-12"
				x-data="carousel()"
			>
				<% if (typeof animes !== 'undefined' && animes.length > 0) { %>
				<!-- Dynamic background that changes with carousel -->
				<div class="absolute inset-0 -z-10">
					<% animes.forEach((anime, index) => { %>
					<img
						x-show="current === <%= index %>"
						x-transition:enter="transition ease-out duration-700"
						x-transition:enter-start="opacity-0"
						x-transition:enter-end="opacity-50"
						x-transition:leave="transition ease-in duration-300"
						x-transition:leave-start="opacity-50"
						x-transition:leave-end="opacity-0"
						src="/images/backgrounds/<%= anime.backgroundImage %>"
						alt="Background <%= anime.title %>"
						class="absolute inset-0 w-full h-full object-cover opacity-50"
					/>
					<% }) %>
					<div
						class="absolute inset-0 bg-gradient-to-b from-black/40 via-black/60 to-black/80"
					></div>
				</div>
				<% } else { %>
				<!-- Static background when no animes -->
				<div class="absolute inset-0 -z-10 bg-gray-900"></div>
				<% } %>

				<div class="container mx-auto px-4 py-8">
					<header class="mb-12 text-center">
						<h1
							class="text-4xl md:text-5xl font-bold text-white drop-shadow-lg mb-3"
						>
							CatÃ¡logo de Animes
						</h1>
						<p class="text-gray-300 text-lg drop-shadow-sm">
							Explore, favorite e gerencie sua lista pessoal.
						</p>
					</header>

					<% if (typeof animes !== 'undefined' && animes.length > 0) {
					%>

					<div class="relative max-w-7xl mx-auto">
						<div
							class="overflow-hidden rounded-3xl shadow-2xl bg-gradient-to-r from-black/80 via-black/70 to-black/80 backdrop-blur-xl border border-white/10"
						>
							<div
								class="flex transition-transform duration-500 ease-out"
								:style="`transform: translateX(-${current * 100}%)`"
							>
								<% animes.forEach((anime) => { %>
								<div class="min-w-full flex justify-center p-0">
									<div
										class="card w-full flex flex-col lg:flex-row bg-transparent h-auto lg:h-[500px] gap-6 lg:gap-8 p-6 lg:p-8"
									>
										<!-- Poster Section with Title Overlay -->
										<div
											class="w-full lg:w-2/5 h-64 lg:h-full relative overflow-hidden group rounded-2xl flex-shrink-0"
										>
											<img
												src="/images/posters/<%= anime.poster || 'default-poster.svg' %>"
												alt="<%= anime.title %>"
												class="absolute inset-0 w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
											/>
											<!-- Title Overlay Gradient -->
											<div
												class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent opacity-60"
											></div>

											<!-- Title Image Overlay -->
											<div
												class="absolute bottom-0 inset-x-0 h-40 flex items-end justify-center pb-6 px-4"
											>
												<img
													src="/images/titles/<%= anime.backgroundImage.replace('background', 'title').replace('.webp', '') %>.webp"
													alt="<%= anime.title %>"
													class="max-h-28 w-auto object-contain drop-shadow-2xl"
													onerror="this.style.display='none'"
												/>
											</div>
										</div>

										<!-- Content Section -->
										<div
											class="w-full lg:w-3/5 flex flex-col justify-between text-white"
										>
											<!-- Info Section -->
											<div class="space-y-5">
												<!-- Title -->
												<div>
													<h3
														class="text-3xl lg:text-4xl font-bold text-white mb-4"
													>
														<%= anime.title %>
													</h3>

													<!-- Metadata Badges -->
													<div
														class="flex flex-wrap gap-2 mb-4"
													>
														<span
															class="px-4 py-2 bg-white/10 hover:bg-white/20 transition rounded-full border border-white/20 text-sm font-semibold"
														>
															ğŸ“… <%= anime.year %>
														</span>
														<span
															class="px-4 py-2 bg-white/10 hover:bg-white/20 transition rounded-full border border-white/20 text-sm font-semibold"
														>
															ğŸ­ <%= anime.genre
															%>
														</span>
														<span
															class="px-4 py-2 bg-white/10 hover:bg-white/20 transition rounded-full border border-white/20 text-sm font-semibold"
														>
															â±ï¸ <%=
															anime.duration %>
														</span>
														<span
															class="px-4 py-2 bg-white/10 hover:bg-white/20 transition rounded-full border border-white/20 text-sm font-semibold"
														>
															ğŸ” <%= anime.rating
															%>
														</span>
													</div>
												</div>

												<!-- Synopsis -->
												<div>
													<h4
														class="text-sm font-semibold text-gray-300 mb-2 uppercase tracking-wider"
													>
														Sinopse
													</h4>
													<p
														class="text-base text-gray-200 line-clamp-6 leading-relaxed"
													>
														<%= anime.synopsis ||
														'Sinopse nÃ£o disponÃ­vel.' %>
													</p>
												</div>
											</div>

											<!-- Action Buttons -->
											<div
												class="flex gap-3 mt-8 flex-wrap"
											>
												<% if (typeof user !==
												'undefined' && user) { %>
												<button
													hx-post="/api/animes/<%= anime.id %>/add/htmx"
													hx-target="#flash-messages"
													hx-swap="beforeend"
													class="flex-1 min-w-[140px] px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition transform hover:scale-105"
													title="Adicionar este anime Ã  sua lista"
												>
													â• Adicionar
												</button>
												<button
													hx-patch="/api/animes/<%= anime.id %>/favorite/htmx"
													hx-target="this"
													hx-swap="outerHTML"
													class="px-6 py-3 border-2 border-red-500 hover:bg-red-500/10 text-white font-bold rounded-lg transition"
													title="Adicionar aos favoritos"
												>
													ğŸ¤
												</button>
												<% } else { %>
												<a
													href="/login"
													class="flex-1 min-w-[140px] text-center px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition transform hover:scale-105"
												>
													ğŸ” Fazer Login
											</a>
											<% } %>
											<a
												href="/anime/<%= anime.id %>"
												class="px-6 py-3 bg-white/10 hover:bg-white/20 text-white font-bold rounded-lg transition"
												title="Ver detalhes completos"
											>
												ğŸ“„ Ver Detalhes
											</a>
											<a
												href="/search?q=<%= anime.title %>"
												class="px-6 py-3 border-2 border-white/30 hover:bg-white/10 text-white font-bold rounded-lg transition"
												title="Buscar animes similares"
											>
												ğŸ” Buscar Similar
											</a>
										</div>
										</div>
									</div>
								</div>
								<% }) %>
							</div>
						</div>

						<!-- Navigation Arrows -->
						<% if (animes.length > 1) { %>
						<button
							@click="prev()"
							class="absolute -left-6 lg:-left-16 top-1/2 -translate-y-1/2 z-10 bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-full shadow-2xl transition transform hover:scale-110"
							title="Anterior"
						>
							â—€
						</button>
						<button
							@click="next()"
							class="absolute -right-6 lg:-right-16 top-1/2 -translate-y-1/2 z-10 bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-full shadow-2xl transition transform hover:scale-110"
							title="PrÃ³ximo"
						>
							â–¶
						</button>
						<% } %>

						<!-- Slide Indicators -->
						<div class="flex justify-center gap-3 mt-8">
							<template x-for="i in total" :key="i">
								<button
									@click="go(i-1)"
									class="w-4 h-4 rounded-full transition-all border-2"
									:class="current === (i-1) ? 'bg-blue-500 border-blue-400 scale-125' : 'bg-white/20 border-white/40 hover:bg-white/30'"
									:title="`Slide ${i}`"
								></button>
							</template>
						</div>
					</div>

					<script id="animes-meta" type="application/json">
						<%- JSON.stringify({ total: animes.length }) %>
					</script>

					<% } else { %>
					<div
						class="text-center text-white py-20 bg-black/50 rounded-2xl backdrop-blur-sm border border-white/10"
					>
						<p class="text-2xl font-bold mb-3">
							ğŸ˜¢ Nenhum anime encontrado
						</p>
						<p class="text-gray-300">
							Volte mais tarde para ver nossa coleÃ§Ã£o
						</p>
					</div>
					<% } %>
				</div>

				<script>
					function carousel() {
						// Tenta ler o JSON, se falhar retorna 0 para evitar erros
						let meta = { total: 0 };
						try {
							const metaEl =
								document.getElementById("animes-meta");
							if (metaEl) meta = JSON.parse(metaEl.textContent);
						} catch (e) {
							console.error(
								"Erro ao ler metadados dos animes",
								e
							);
						}

						return {
							current: 0,
							total: meta.total,

							// Initialize keyboard navigation
							init() {
								window.addEventListener("keydown", (e) => {
									if (e.key === "ArrowLeft") {
										e.preventDefault();
										this.prev();
									} else if (e.key === "ArrowRight") {
										e.preventDefault();
										this.next();
									}
								});
							},

							next() {
								if (this.total === 0) return;
								this.current = (this.current + 1) % this.total;
							},
							prev() {
								if (this.total === 0) return;
								this.current =
									(this.current - 1 + this.total) %
									this.total;
							},
							go(i) {
								this.current = i;
							},
						};
					}
				</script>
			</section>
		</main>

		<%- include('../partials/footer') %>
	</body>
</html>
