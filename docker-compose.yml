# =============================================================================
# myMemorableAnimes - Docker Compose Configuration
# Development and Production orchestration
# =============================================================================
# Usage:
#   Development: docker-compose up -d
#   Production:  docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#   Logs:        docker-compose logs -f app
#   Stop:        docker-compose down
#   Rebuild:     docker-compose up -d --build
# =============================================================================

name: mymemorableanimes

services:
  # ===========================================================================
  # Main Application Service
  # ===========================================================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
      # Build arguments (optional)
      args:
        - NODE_ENV=production
    image: mymemorableanimes:latest
    container_name: mymemorableanimes-app
    
    # Restart policy
    restart: unless-stopped
    
    # Port mapping (host:container)
    ports:
      - "${APP_PORT:-3000}:3000"
    
    # Environment variables
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3000
      SESSION_SECRET: ${SESSION_SECRET:-dev-secret-key-change-in-production-min-32-chars}
      DATABASE_URL: ${DATABASE_URL:-./database/database.db}
      JIKAN_API_BASE: ${JIKAN_API_BASE:-https://api.jikan.moe/v4}
      # Security settings (production)
      SECURE_COOKIES: ${SECURE_COOKIES:-false}
      SAME_SITE: ${SAME_SITE:-Lax}
    
    # Volume mounts
    volumes:
      # Database persistence (REQUIRED for data retention)
      - app_database:/app/database
      # Optional: Custom public assets
      # - ./public/images:/app/public/images:ro
    
    # Health check configuration
    healthcheck:
      test: ["CMD", "node", "-e", "const http = require('http'); http.get('http://localhost:3000/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    # Resource limits (adjust based on your server)
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    
    # Network configuration
    networks:
      - app_network
    
    # Dependencies (if using external services)
    # depends_on:
    #   postgres:
    #     condition: service_healthy

  # ===========================================================================
  # PostgreSQL Database (Optional - for production scaling)
  # Uncomment and configure if you need PostgreSQL instead of SQLite
  # ===========================================================================
  # postgres:
  #   image: postgres:16-alpine
  #   container_name: mymemorableanimes-db
  #   restart: unless-stopped
  #   
  #   environment:
  #     POSTGRES_USER: ${DB_USER:-animes}
  #     POSTGRES_PASSWORD: ${DB_PASSWORD:-changeme}
  #     POSTGRES_DB: ${DB_NAME:-mymemorableanimes}
  #     PGDATA: /var/lib/postgresql/data/pgdata
  #   
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data
  #     # Optional: Custom initialization scripts
  #     # - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
  #   
  #   ports:
  #     - "${DB_PORT:-5432}:5432"
  #   
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-animes} -d ${DB_NAME:-mymemorableanimes}"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #     start_period: 10s
  #   
  #   networks:
  #     - app_network
  #   
  #   # Only start when explicitly requested
  #   profiles:
  #     - postgres

  # ===========================================================================
  # Nginx Reverse Proxy (Optional - for production with SSL)
  # ===========================================================================
  # nginx:
  #   image: nginx:alpine
  #   container_name: mymemorableanimes-proxy
  #   restart: unless-stopped
  #   
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #   
  #   volumes:
  #     - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
  #     - ./nginx/ssl:/etc/nginx/ssl:ro
  #     - ./public:/var/www/static:ro
  #   
  #   depends_on:
  #     app:
  #       condition: service_healthy
  #   
  #   networks:
  #     - app_network
  #   
  #   profiles:
  #     - production

# =============================================================================
# Volumes - Persistent data storage
# =============================================================================
volumes:
  # SQLite database persistence
  app_database:
    driver: local
    name: mymemorableanimes_database
  
  # PostgreSQL data (if using postgres profile)
  # postgres_data:
  #   driver: local
  #   name: mymemorableanimes_postgres

# =============================================================================
# Networks - Container communication
# =============================================================================
networks:
  app_network:
    driver: bridge
    name: mymemorableanimes_network
